pipeline {
  agent any

  environment {
    DEPLOY_ENV = 'production'
    DOCKER_IMAGE = "ghcr.io/Paul-Fridrick/portfolio"
    DOCKER_TAG = "${env.BUILD_NUMBER}"
    GITHUB_TOKEN = credentials('github-pat')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install dependencies') {
      steps {
        sh 'npm ci'
      }
    }

    stage('Build Angular') {
      steps {
        sh "npm run build -- --configuration=${DEPLOY_ENV}"
      }
    }

    stage('Build Docker Image') {
      steps {
        sh "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
      }
    }

    stage('Push to GHCR') {
      steps {
        sh '''
          echo "${GITHUB_TOKEN}" | docker login ghcr.io -u Paul-Fridrick --password-stdin
          docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
        '''
      }
    }

    stage('Deploy Locally') {
        steps {
            sh '''
                echo "${GITHUB_TOKEN}" | docker login ghcr.io -u Paul-Fridrick --password-stdin
                docker pull ${DOCKER_IMAGE}:${DOCKER_TAG}
                docker stop portfolio || true
                docker rm portfolio || true
                docker run -d --name portfolio -p 80:80 ${DOCKER_IMAGE}:${DOCKER_TAG}
            '''
        }
    }
  }
}
